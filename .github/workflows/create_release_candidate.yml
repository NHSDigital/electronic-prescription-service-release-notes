name: "Create confluence release candidate"

on:
  workflow_call:
    inputs:
      CURRENT_DEPLOYED_TAG:
        description: "The current deployed tag. Eg. 'v1.2.3'"
        required: true
        type: string
      RELEASE_TAG:
        description: "The release tag to create the release candidate for. Eg. 'v1.2.4'"
        required: true
        type: string
      REPO_NAME:
        description: "The name of the repository."
        required: true
        type: string
      TARGET_ENV:
        description: "The target environment for the release candidate. Eg. 'INT'"
        required: true
        type: string
      PRODUCT_NAME:
        description: "The name of the product. Eg. 'Prescriptions for Patients AWS layer'"
        required: true
        type: string
      PAGE_ID:
        description: "The confluence page ID to create the release notes on"
        required: true
        type: string
      RELEASE_PREFIX:
        description: "The release candidate prefix to prepend to the version tag. Eg. 'PfP-AWS' for 'PfP-AWS-v1.2.3'"
        required: true
        type: string
    secrets:
      DEV_CLOUD_FORMATION_EXECUTE_LAMBDA_ROLE:
        description: "The role to assume in the dev account to execute the lambda"
        required: true
      LAMBDA_GITHUB_TOKEN:
        description: "GitHub token with permissions to access the repository"
        required: false

jobs:
  create-release-candidate:
    runs-on: ubuntu-22.04
    permissions:
      id-token: write
    steps:
      - name: "Checkout"
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
        with:
          repository: "NHSDigital/electronic-prescription-service-release-notes"
          sparse-checkout: |
            .github

      - name: Connect to dev AWS account
        uses: aws-actions/configure-aws-credentials@8df5847569e6427dd6c4fb1cf565c83acfa8afa7
        with:
          aws-region: eu-west-2
          role-to-assume: ${{ secrets.DEV_CLOUD_FORMATION_EXECUTE_LAMBDA_ROLE }}
          role-session-name: ${{ inputs.RELEASE_PREFIX }}-release-notes-run-lambda
          unset-current-credentials: true

      - name: "Create release candidate"
        shell: bash
        working-directory: .github/scripts
        env:
          CURRENT_DEPLOYED_TAG: ${{ inputs.CURRENT_DEPLOYED_TAG }}
          RELEASE_TAG: ${{ inputs.RELEASE_TAG }}
          REPO_NAME: ${{ inputs.REPO_NAME }}
          TARGET_ENV: ${{ inputs.TARGET_ENV }}
          PRODUCT_NAME: ${{ inputs.PRODUCT_NAME }}
          PAGE_ID: ${{ inputs.PAGE_ID }}
          RELEASE_PREFIX: ${{ inputs.RELEASE_PREFIX }}
          LAMBDA_GITHUB_TOKEN: ${{ secrets.LAMBDA_GITHUB_TOKEN }}
        run: ./create_release_candidate.sh
